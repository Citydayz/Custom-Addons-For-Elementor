# Cursor Rules â€” 03 WP & Elementor Standards (Authoritative)
> **Project:** Custom Addons for Elementor by Hugo Scheer  
> **Scope:** Coding standards and usage rules for WordPress + Elementor.  
> **Hierarchy:** If conflicts arise, `01-project.mdc` prevails; this file prevails over others afterward.

---

## ðŸŽ¯ Objectif
Garantir que **chaque livrable** respecte les conventions WordPress + Elementor : API, sÃ©curitÃ© de base (sanitize/escape/nonces), i18n, enqueue propre, et contrÃ´les Elementor cohÃ©rents avec **Global Colors/Global Typography**.

---

## ðŸ§¾ En-tÃªte Plugin & i18n
- **Fichier principal** : inclure lâ€™en-tÃªte WP standard (voir `01-project.mdc`).  
- **Textdomain** : `cae`. Toujours envelopper les chaÃ®nes visibles utilisateur : `__()`, `_e()`, `_x()`.  
- **Chargement i18n** : au `plugins_loaded` ou dÃ¨s le bootstrap.
```php
load_plugin_textdomain( 'cae', false, dirname( plugin_basename( __FILE__ ) ) . '/languages' );
```
- **Aucune concatÃ©nation** de fragments traduisibles ; prÃ©fÃ©rer les placeholders `sprintf()`.

---

## ðŸ§¹ Nommage & PrÃ©fixes
- **PrÃ©fixe** fonctions/hooks/handles : `cae_...` ; classes : `Cae_...`.  
- **Slug widget** : `cae-{feature}` (ex. `cae-footer`, `cae-hero`).  
- **Handles** scripts/styles = slug (ex. `cae-footer`).  
- **Racine CSS** scope : `.{widget-slug}` (ex. `.cae-footer`).

---

## ðŸ”Œ Hooks essentiels
- Bootstrap : `plugins_loaded`  
- Registre widgets : `elementor/widgets/register`  
- CatÃ©gorie widgets (facultatif) : `elementor/elements/categories_registered`  
- Enqueue : `wp_enqueue_scripts` (registre global) + stratÃ©gie conditionnelle (voir 02)  
- Admin notices (erreurs dÃ©pendances) : `admin_notices`

---

## ðŸ§  SÃ©curitÃ© WordPress (baseline)
**Toujours** valider et Ã©chapper :

### Validation (entrÃ©e)
- `sanitize_text_field()`, `sanitize_email()`, `sanitize_key()`, `esc_url_raw()`, `absint()`, `intval()`â€¦  
- RequÃªtes SQL : **uniquement** via `$wpdb->prepare()`.

### Ã‰chappement (sortie)
- `esc_html()`, `esc_attr()`, `esc_url()`, `wp_kses_post()` si HTML autorisÃ©.

### Nonces
- CrÃ©er : `wp_create_nonce( 'cae_action' )` ; VÃ©rifier : `wp_verify_nonce( $_REQUEST['_wpnonce'], 'cae_action' )`.

### Exemple
```php
$menu_id = isset($_POST['menu_id']) ? absint($_POST['menu_id']) : 0;
if ( isset($_POST['_wpnonce']) && wp_verify_nonce($_POST['_wpnonce'], 'cae_update') ) {
  // Safe updateâ€¦
}
echo '<a href="' . esc_url( $url ) . '" class="' . esc_attr( $class ) . '">' . esc_html( $label ) . '</a>';
```

---

## ðŸ“¦ Enqueue (scripts/styles) â€” RÃ¨gles
- **Enregistrer** globalement (version = `CAE_VERSION`) ; **enqueuer** **seulement** sur les pages qui utilisent le widget.  
- Pas dâ€™inline CSS/JS (sauf donnÃ©es minimales, Ã©chappÃ©es).  
- DÃ©pendances explicites (`array('jquery')` seulement si nÃ©cessaire).

```php
// Global register (done once)
wp_register_style( 'cae-global', CAE_URL . 'assets/css/global.css', [], CAE_VERSION );
wp_register_script( 'cae-global', CAE_URL . 'assets/js/global.js', [], CAE_VERSION, true );

// Per-widget register (example)
wp_register_style( 'cae-footer', CAE_URL . 'assets/css/cae-footer.css', [], CAE_VERSION );
wp_register_script( 'cae-footer', CAE_URL . 'assets/js/cae-footer.js', [], CAE_VERSION, true );
```

> Lâ€™enqueue conditionnel est dÃ©crit dans `02-architecture.mdc` (registry/Elementor hooks).

---

## ðŸ§© Standards Elementor â€” Widget Base
Chaque widget **doit** Ã©tendre `\Elementor\Widget_Base` et implÃ©menter :
- `get_name()` â†’ slug (`cae-footer`)  
- `get_title()` â†’ `__('CAE Footer','cae')`  
- `get_icon()` â†’ icÃ´ne Elementor (`eicon-...`)  
- `get_categories()` â†’ `['general']` ou catÃ©gorie perso `cae-widgets`  
- `register_controls()` â†’ sections **Content** + **Style**  
- `render()` â†’ HTML **sÃ©mantique** et **Ã©chappÃ©**

### Squelette minimal
```php
class Cae_Footer_Widget extends \Elementor\Widget_Base {
  public function get_name() { return 'cae-footer'; }
  public function get_title() { return __( 'CAE Footer', 'cae' ); }
  public function get_icon() { return 'eicon-footer'; }
  public function get_categories() { return [ 'general' ]; }
  protected function register_controls() { /* content + style */ }
  protected function render() {
    echo '<footer class="cae-footer">';
    echo esc_html( $this->get_settings_for_display('legal_text') );
    echo '</footer>';
  }
}
```

---

## ðŸŽ›ï¸ Controls â€” Bonnes pratiques
- Utiliser les **Controls Manager** : `TEXT`, `TEXTAREA`, `SELECT`, `SWITCHER`, `NUMBER`, `URL`, `COLOR`, **Responsive controls** si pertinent.  
- **Defaults** : pointer vers **Global Colors / Global Typography** pour hÃ©riter du kit Elementor.  
- **Sanitization** : `default` sÃ»r, `selectors` pour appliquer les styles dans le scope `.cae-{widget}`.

### Exemple â€” Content Controls
```php
$this->start_controls_section( 'section_content', [
  'label' => __( 'Content', 'cae' ),
] );

$this->add_control( 'show_logo', [
  'label' => __( 'Show Logo', 'cae' ),
  'type'  => \Elementor\Controls_Manager::SWITCHER,
  'default' => 'yes',
] );

$this->add_control( 'legal_text', [
  'label' => __( 'Legal Text', 'cae' ),
  'type'  => \Elementor\Controls_Manager::TEXT,
  'default' => sprintf( __( 'Â© %s All rights reserved', 'cae' ), date('Y') ),
] );

$this->end_controls_section();
```

### Exemple â€” Style Controls (Global defaults)
> Les APIs Global Colors/Global Typography dâ€™Elementor Ã©voluent ; utiliser la mÃ©canique de **selectors** et, quand disponible, les **global tokens** fournis par Elementor dans le panneau.
```php
$this->start_controls_section( 'section_style', [
  'label' => __( 'Style', 'cae' ),
  'tab'   => \Elementor\Controls_Manager::TAB_STYLE,
] );

$this->add_control( 'text_color', [
  'label' => __( 'Text Color', 'cae' ),
  'type'  => \Elementor\Controls_Manager::COLOR,
  'selectors' => [
    '{{WRAPPER}} .cae-footer' => 'color: {{VALUE}};',
  ],
] );

$this->add_responsive_control( 'padding', [
  'label' => __( 'Padding', 'cae' ),
  'type'  => \Elementor\Controls_Manager::DIMENSIONS,
  'size_units' => [ 'px', '%', 'em', 'rem' ],
  'selectors' => [
    '{{WRAPPER}} .cae-footer' => 'padding: {{TOP}}{{UNIT}} {{RIGHT}}{{UNIT}} {{BOTTOM}}{{UNIT}} {{LEFT}}{{UNIT}};',
  ],
] );

$this->end_controls_section();
```

---

## ðŸ§­ Menus WordPress (exemple Footer)
SÃ©lecteur de menu via `wp_get_nav_menus()` puis rendu sÃ©curisÃ© avec `wp_nav_menu()`.
```php
$menus = wp_get_nav_menus();
$options = [ '' => __( 'â€” Select â€”', 'cae' ) ];
foreach ( $menus as $m ) { $options[ $m->term_id ] = $m->name; }

$this->add_control( 'menu_id', [
  'label' => __( 'Menu', 'cae' ),
  'type'  => \Elementor\Controls_Manager::SELECT,
  'options' => $options,
] );

// Render
$menu_id = absint( $this->get_settings_for_display('menu_id') );
if ( $menu_id ) {
  wp_nav_menu([ 'menu' => $menu_id, 'container' => 'nav', 'menu_class' => 'cae-footer__menu' ]);
}
```

---

## â™»ï¸ DonnÃ©es dynamiques & AnnÃ©e lÃ©gale
- PrÃ©fÃ©rer `date('Y')` cÃ´tÃ© PHP pour lâ€™annÃ©e par dÃ©faut.  
- Autoriser la **surcharge** via control `legal_text` (Ã©chappÃ© Ã  lâ€™affichage).  
- Si HTML autorisÃ© pour le texte, utiliser `wp_kses_post()` au `render()`.

```php
$txt = $this->get_settings_for_display('legal_text');
echo wp_kses_post( $txt );
```

---

## ðŸš« DÃ©prÃ©ciations & Compat
- **Ne pas** utiliser dâ€™APIs Elementor dÃ©prÃ©ciÃ©es ; vÃ©rifier les mÃ©thodes `Widget_Base` obligatoires.  
- VÃ©rifier la prÃ©sence dâ€™Elementor : `did_action('elementor/loaded')`.  
- Fournir un **admin notice** clair si Elementor est manquant (et ne pas casser le site).

---

## âœ… Definition of Done (Standards)
- Tous les textes traduisibles et textdomain correct (`cae`).  
- EntrÃ©es **sanitized**, sorties **escaped**.  
- Assets **enregistrÃ©s** globalement, **enqueued** conditionnellement.  
- Controls Elementor complets (content + style) avec hÃ©ritage global par dÃ©faut.  
- Rendu **sÃ©mantique**, **accessible** (voir `05-accessibility.mdc`) et **scopÃ©**.

---

## â›” Interdits
- ConcatÃ©ner du HTML non Ã©chappÃ© avec des variables.  
- RequÃªtes SQL brutes sans `prepare()`.  
- Charger les assets dâ€™un widget sur toutes les pages.  
- ChaÃ®nes non traduites ou sans textdomain.

---

## ðŸ§­ Agent Routing
- ImplÃ©mentation de contrÃ´les/rendu â†’ **Agent 1**  
- Ajustements de structure/nommage â†’ **Agent 2**  
- SÃ©curitÃ© (sanitize/escape/prepare/nonce) â†’ **Agent 3**  
- A11y des templates â†’ **Agent 4**  
- Enqueue/perf â†’ **Agent 5**  
- I18n/l10n â†’ **Agent 2** (style) + **Agent 0** (validation finale)

---

**End of 03 WP & Elementor Standards â€” Authoritative.**
